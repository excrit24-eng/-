<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂÜ¨Â§©ÁöÑÊù±‰∫¨ - Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-cream': '#FAF9F6', 
                        'jp-yellow': '#F3E5AB', 
                        'jp-yellow-dark': '#E6D285', 
                        'jp-text': '#4A4A4A',   
                        'jp-gray': '#9CA3AF',
                        'jp-accent': '#84A59D',
                        'jp-blue': '#4285F4',
                        'jp-red': '#EA4335',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f0f0f0;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #app {
            max-width: 480px;
            margin: 0 auto;
            background-color: #FAF9F6;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        #map-container { height: 100%; width: 100%; z-index: 1; }
        
        .sortable-ghost { opacity: 0.4; background: #F3E5AB; }
        .sortable-drag { cursor: grabbing; }

        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        
        .timeline-connector {
            position: absolute;
            left: 27px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background-image: linear-gradient(to bottom, #E5E7EB 50%, transparent 50%);
            background-size: 2px 10px;
            z-index: 0;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app">
    <!-- Header -->
    <header class="bg-jp-cream px-5 pt-12 pb-3 sticky top-0 z-20 border-b border-stone-100 shadow-sm flex justify-between items-center">
        <div @click="editTitle" class="cursor-pointer">
            <h1 class="text-xl font-bold text-jp-text tracking-widest truncate max-w-[200px]">{{ appTitle }}</h1>
            <p class="text-xs text-jp-gray tracking-wider">{{ getDayRange() }}</p>
        </div>
        
        <div v-if="currentWeather" class="flex items-center space-x-2 bg-white px-2 py-1 rounded-lg shadow-sm border border-stone-100">
            <div class="text-center">
                <i :class="getWeatherIcon(currentWeather.weathercode)" class="text-jp-blue text-lg"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-sm font-bold text-jp-text">{{ currentWeather.temp_max }}¬∞ / {{ currentWeather.temp_min }}¬∞</span>
                <span class="text-[9px] text-gray-500">{{ getClothingAdvice(currentWeather.temp_max, currentWeather.temp_min) }}</span>
            </div>
        </div>

        <div class="flex items-center space-x-2">
            <button @click="showShoppingModal = true" class="relative p-2 text-jp-text hover:text-jp-accent transition">
                <i class="fa-solid fa-bag-shopping text-xl"></i>
                <span v-if="shoppingList.length > 0" class="absolute top-0 right-0 bg-red-400 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center border border-white">
                    {{ shoppingList.length }}
                </span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto pb-24 relative hide-scrollbar scroll-smooth">
        
        <!-- Tab 1: Ë°åÁ®ã -->
        <div v-show="currentTab === 'itinerary'" class="space-y-4">
            <div class="sticky top-0 bg-jp-cream z-10 py-2 pl-4 border-b border-stone-50 shadow-sm">
                <div class="flex space-x-2 overflow-x-auto hide-scrollbar pr-4 pb-2">
                    <button @click="selectedDate = 'todo'" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all border" :class="selectedDate === 'todo' ? 'bg-jp-accent text-white border-jp-accent shadow-md transform -translate-y-1' : 'bg-white border-stone-100 text-gray-400'">
                        <i class="fa-solid fa-list-check mb-1 text-lg"></i>
                        <span class="text-[10px] font-bold">TODO</span>
                    </button>
                    <button v-for="(date, index) in tripDates" :key="index" @click="selectedDate = date; fetchWeather(date);" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all border" :class="selectedDate === date ? 'bg-jp-yellow border-jp-yellow-dark text-jp-text shadow-md transform -translate-y-1' : 'bg-white border-stone-100 text-gray-400'">
                        <span class="text-[10px] uppercase font-bold text-gray-500">{{ date.split('-')[1] }}/{{ date.split('-')[2] }}</span>
                        <span class="text-sm font-bold">{{ getWeekDay(date) }}</span>
                    </button>
                </div>
            </div>

            <!-- TODO View -->
            <div v-if="selectedDate === 'todo'" class="px-5 mt-4">
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-stone-50">
                    <h3 class="font-bold text-jp-text mb-4 flex items-center text-lg"><i class="fa-solid fa-clipboard-check text-jp-accent mr-2"></i> Ë°åÂâçÊ∏ÖÂñÆ</h3>
                    <div class="space-y-3">
                        <div v-for="todo in todos" :key="todo.id" class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded-lg group transition-colors">
                            <input type="checkbox" v-model="todo.done" class="w-5 h-5 rounded border-gray-300 text-jp-accent focus:ring-jp-accent cursor-pointer">
                            <span :class="{'line-through text-gray-300': todo.done}" class="flex-1 text-sm font-medium">{{ todo.text }}</span>
                            <button @click="deleteTodo(todo.id)" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-2 pt-4 border-t border-gray-100">
                        <input v-model="newTodoText" @keyup.enter="addTodo" placeholder="Êñ∞Â¢ûÂæÖËæ¶..." class="flex-1 bg-gray-50 px-4 py-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-jp-accent/20">
                        <button @click="addTodo" class="bg-jp-accent text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm">Êñ∞Â¢û</button>
                    </div>
                </div>
            </div>

            <!-- Itinerary List -->
            <div v-else class="px-5 mt-4 pb-20">
                <div class="mb-4 space-y-2">
                    <div class="bg-white p-2 rounded-xl border border-stone-100 shadow-sm flex items-center gap-2">
                        <i class="fa-brands fa-instagram text-pink-500 text-xl ml-2"></i>
                        <input v-model="igSearchText" placeholder="Ëº∏ÂÖ• IG Âú∞ÈªûÂêçÁ®± (Â¶Ç: Ê∂âË∞∑SKY)" class="flex-1 bg-transparent outline-none text-sm text-jp-text">
                        <button @click="searchIgLocation" class="bg-pink-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm active:scale-95">ÊêúÂ∞ã</button>
                    </div>
                    <button v-if="currentDayItinerary.length > 2" @click="optimizeRoute" class="w-full bg-gradient-to-r from-jp-blue to-blue-600 text-white py-2 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI Ë∑ØÂæëÊúÄ‰Ω≥Âåñ
                    </button>
                </div>

                <div v-if="currentDayItinerary.length === 0" class="text-center py-12 opacity-50">
                    <div class="bg-white inline-flex p-4 rounded-full mb-3 shadow-sm"><i class="fa-solid fa-route text-3xl text-jp-yellow-dark"></i></div>
                    <p class="text-sm font-medium text-gray-400">Day {{ getDayIndex(selectedDate) }} Â∞öÁÑ°Ë°åÁ®ã</p>
                </div>

                <div ref="sortableList" class="space-y-0 relative"> 
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" :data-id="item.id" class="relative pb-6 group">
                        <div v-if="index < currentDayItinerary.length - 1" class="timeline-connector"></div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-stone-50 relative z-10 active:scale-[0.99] transition-all hover:shadow-md">
                            <div class="absolute right-0 top-0 p-4 text-gray-300 cursor-grab handle hover:text-jp-text z-20"><i class="fa-solid fa-grip-vertical"></i></div>
                            <div class="flex items-start">
                                <div class="flex flex-col items-center mr-4 mt-1 min-w-[50px] z-10 bg-white">
                                    <span class="text-sm font-mono font-bold text-jp-text bg-gray-100 px-2 py-0.5 rounded-md">{{ item.time }}</span>
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm mt-2 shadow-sm border-2 border-white" :class="getTypeColor(item.type)"><i :class="getTypeIcon(item.type)"></i></div>
                                </div>
                                <div class="flex-1 pr-8">
                                    <h3 class="text-base font-bold text-jp-text leading-tight">{{ item.location }}</h3>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span class="text-[10px] px-2 py-0.5 bg-gray-50 text-gray-500 rounded border border-gray-100">{{ getTypeName(item.type) }}</span>
                                        <span v-if="item.nursing" class="text-[10px] px-2 py-0.5 bg-pink-100 text-pink-500 rounded flex items-center"><i class="fa-solid fa-baby-carriage mr-1"></i>ËÇ≤Â¨∞</span>
                                    </div>
                                    <p v-if="item.note" class="text-xs text-gray-500 mt-2 bg-jp-cream p-2 rounded-lg border border-stone-100">{{ item.note }}</p>
                                    <div class="flex items-center mt-3 space-x-3 border-t border-gray-50 pt-2">
                                        <button @click="editItem(item)" class="text-xs text-gray-400 hover:text-jp-text"><i class="fa-solid fa-pen mr-1"></i>Á∑®ËºØ</button>
                                        <button @click="deleteItem(item.id)" class="text-xs text-gray-400 hover:text-red-400"><i class="fa-solid fa-trash mr-1"></i>Âà™Èô§</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-if="index < currentDayItinerary.length - 1" class="pl-[60px] pr-2 py-2 relative z-10">
                            <div v-if="item.transport" class="bg-gray-100 rounded-lg p-2 flex justify-between items-center text-xs text-gray-600 border border-gray-200">
                                <div class="flex items-center space-x-2"><i :class="getTransportIcon(item.transport.mode)"></i><span>{{ item.transport.time }}ÂàÜ</span><span v-if="item.transport.cost > 0" class="bg-white px-1 rounded text-jp-text font-mono">¬•{{ item.transport.cost }}</span></div>
                                <button @click="openTransportModal(item, currentDayItinerary[index+1])" class="text-jp-blue hover:text-blue-600"><i class="fa-solid fa-pen"></i></button>
                            </div>
                            <button v-else @click="openTransportModal(item, currentDayItinerary[index+1])" class="text-[10px] text-gray-400 bg-white border border-dashed border-gray-300 rounded-full px-3 py-1 hover:bg-gray-50 hover:text-jp-blue hover:border-jp-blue transition-colors flex items-center"><i class="fa-solid fa-diamond-turn-right mr-1"></i> Ë®≠ÂÆö‰∫§ÈÄö</button>
                        </div>
                    </div>
                </div>
                <button @click="openAddItemModal" class="w-full py-4 rounded-xl border-2 border-dashed border-jp-yellow-dark text-jp-yellow-dark font-bold hover:bg-jp-yellow/20 transition-colors mt-4 flex items-center justify-center gap-2"><i class="fa-solid fa-plus-circle"></i> Êñ∞Â¢ûË°åÁ®ã</button>
            </div>
        </div>

        <!-- Tab 2: Map -->
        <div v-show="currentTab === 'map'" class="h-full w-full absolute top-0 left-0 bg-gray-100">
             <div id="map-container"></div>
             <div class="absolute top-4 left-4 right-4 z-[400] space-y-2">
                 <div class="bg-white/95 backdrop-blur rounded-xl p-3 shadow-lg border border-white/50 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">MAP VIEW</p>
                        <p class="font-bold text-jp-text text-sm">{{ selectedDate === 'todo' ? 'Ë´ãÈÅ∏ÊìáÊó•Êúü' : selectedDate }}</p>
                    </div>
                    <button @click="locateUser" class="bg-white w-10 h-10 rounded-full shadow-sm flex items-center justify-center text-blue-500"><i class="fa-solid fa-crosshairs"></i></button>
                 </div>
                 <a v-if="selectedDate !== 'todo' && currentDayItinerary.length > 0" :href="getGoogleMapsRouteLink()" target="_blank" class="block w-full bg-blue-600 text-white text-center py-3 rounded-xl shadow-lg font-bold text-sm hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-route"></i> ÈñãÂïü Google Maps Êï¥Êó•Ë∑ØÁ∑ö</a>
             </div>
        </div>

        <!-- Tab 3: Expenses -->
        <div v-show="currentTab === 'expenses'" class="px-5 pt-6 pb-24">
            <div class="bg-jp-text rounded-2xl p-6 text-white shadow-xl mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-wallet text-9xl"></i></div>
                <h3 class="text-xs font-bold opacity-60 mb-1 uppercase">Total Expenses (TWD)</h3>
                <div class="text-3xl font-mono font-bold">NT$ {{ grandTotalTWD.toLocaleString() }}</div>
                <div class="mt-4 flex items-center space-x-2 text-xs bg-white/10 w-fit px-3 py-1 rounded-full backdrop-blur-sm"><span>ÂåØÁéá: {{ exchangeRate }} | Âê´‰∫§ÈÄöË≤ª</span></div>
            </div>
            <div v-for="(group, date) in groupedExpenses" :key="date" class="mb-6">
                <div class="flex items-center mb-2 sticky top-0 bg-jp-cream py-2 z-10"><div class="w-2 h-2 bg-jp-yellow-dark rounded-full mr-2"></div><h4 class="text-sm font-bold text-gray-500">{{ date }}</h4><div class="flex-1 border-b border-gray-200 ml-3"></div><span class="text-xs font-mono text-gray-400 ml-2">NT$ {{ getDailyTotal(group).toLocaleString() }}</span></div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-50 overflow-hidden">
                    <div v-for="exp in group" :key="exp.id" class="p-4 border-b border-gray-50 last:border-0 flex justify-between items-center relative group">
                        <div class="flex items-center space-x-3"><div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 text-sm"><i :class="getCategoryIcon(exp.category)"></i></div><div><p class="text-sm font-bold text-jp-text">{{ exp.item }}</p><p class="text-[10px] text-gray-400">{{ getCategoryName(exp.category) }}</p></div></div>
                        <div class="text-right"><p class="font-bold text-sm font-mono" :class="exp.currency === 'JPY' ? 'text-jp-text' : 'text-blue-600'">{{ exp.currency === 'JPY' ? '¬•' : 'NT$' }} {{ Number(exp.amount).toLocaleString() }}</p><button @click="deleteExpense(exp.id)" class="absolute right-0 top-0 bottom-0 w-12 bg-red-500 text-white opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                </div>
            </div>
            <button @click="showAddExpenseModal = true" class="fixed bottom-24 right-5 bg-jp-text text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-10 hover:bg-black"><i class="fa-solid fa-plus"></i></button>
        </div>

        <!-- Tab 4: Info -->
        <div v-show="currentTab === 'info'" class="px-5 pt-6 space-y-5 pb-24">
            <h2 class="text-xl font-bold text-jp-text">ÊóÖÈÅäË≥áË®äÁ´ô</h2>
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-stone-100">
                <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2"><h3 class="font-bold text-jp-text"><i class="fa-solid fa-bookmark text-jp-yellow-dark mr-2"></i>ÂÇôÁî®ÂèÉËÄÉÊ∏ÖÂñÆ</h3><button @click="showAddInfoModal = true" class="text-xs bg-gray-100 px-3 py-1.5 rounded-full font-bold text-gray-500">+ Êñ∞Â¢û</button></div>
                <div class="space-y-4">
                    <div v-for="info in infoItems" :key="info.id" class="flex justify-between items-start group">
                        <div><div class="flex items-center gap-2"><span class="font-bold text-sm text-jp-text">{{ info.title }}</span><span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-500">{{ info.tag }}</span></div><p class="text-xs text-gray-400 mt-1">{{ info.desc }}</p></div>
                        <div class="flex flex-col items-end gap-2"><a :href="getGoogleMapsLink(info.title)" target="_blank" class="text-blue-500 bg-blue-50 px-2 py-1 rounded text-xs hover:bg-blue-100"><i class="fa-solid fa-diamond-turn-right"></i></a><button @click="deleteInfoItem(info.id)" class="text-gray-300 text-xs hover:text-red-400 opacity-0 group-hover:opacity-100">Âà™Èô§</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Navigation (Restored) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-gray-100 pb-safe pt-1 px-4 flex justify-between items-center h-[88px] z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] max-w-[480px] mx-auto pb-5">
        <button v-for="tab in ['itinerary', 'map', 'expenses', 'info']" :key="tab" @click="switchTab(tab)" class="flex flex-col items-center justify-center w-16 h-full transition-all duration-300 group" :class="currentTab === tab ? 'text-jp-text' : 'text-gray-300'">
            <div class="mb-1 transition-transform group-active:scale-90" :class="currentTab === tab ? '-translate-y-1' : ''">
                <i class="fa-solid text-xl" :class="{'itinerary':'fa-suitcase-rolling','map':'fa-map-location-dot','expenses':'fa-calculator','info':'fa-circle-info'}[tab]"></i>
            </div>
            <span class="text-[10px] font-bold" :class="currentTab === tab ? 'opacity-100' : 'opacity-70'">{{ {'itinerary':'Ë°åÁ®ã','map':'Âú∞Âúñ','expenses':'Ë®òÂ∏≥','info':'Ë≥áË®ä'}[tab] }}</span>
        </button>
    </nav>

    <!-- Modals -->

    <!-- Transport Modal -->
    <transition name="modal">
    <div v-if="showTransportModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-jp-text mb-4">‰∫§ÈÄöË¶èÂäÉ</h3>
            <div class="bg-gray-50 p-3 rounded-xl text-sm mb-4 flex justify-between items-center">
                <span>{{ transportForm.origin }}</span>
                <i class="fa-solid fa-arrow-right text-gray-400"></i>
                <span>{{ transportForm.destination }}</span>
            </div>
            
            <a :href="`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(transportForm.origin)}&destination=${encodeURIComponent(transportForm.destination)}&travelmode=transit`" target="_blank" class="block w-full bg-blue-100 text-blue-600 text-center py-2 rounded-xl text-sm font-bold mb-4 hover:bg-blue-200">
                <i class="fa-brands fa-google"></i> Âú® Google Maps Êü•Ë©¢
            </a>

            <div class="space-y-3">
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">‰∫§ÈÄöÂ∑•ÂÖ∑</label>
                        <select v-model="transportForm.mode" class="w-full bg-gray-50 p-2 rounded-lg outline-none">
                            <option value="train">ÈõªËªä/Âú∞Èêµ</option>
                            <option value="walk">Ê≠•Ë°å</option>
                            <option value="taxi">Ë®àÁ®ãËªä</option>
                            <option value="bus">Â∑¥Â£´</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">ÊâÄÈúÄÊôÇÈñì(ÂàÜ)</label>
                        <input type="number" v-model="transportForm.time" class="w-full bg-gray-50 p-2 rounded-lg outline-none">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ËªäË≥á (Êó•Âπ£)</label>
                    <input type="number" v-model="transportForm.cost" placeholder="0" class="w-full bg-gray-50 p-2 rounded-lg outline-none">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="showTransportModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl text-gray-500 font-bold">ÂèñÊ∂à</button>
                <button @click="saveTransport" class="flex-1 py-3 bg-jp-yellow text-jp-text font-bold rounded-xl shadow-md">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>
    </transition>

    <!-- Shopping Modal (With Owner Tabs & Categories) -->
    <transition name="modal">
    <div v-if="showShoppingModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[750px] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-jp-text flex items-center"><i class="fa-solid fa-bag-shopping text-jp-yellow-dark mr-2"></i>Ë≥ºÁâ©Ê∏ÖÂñÆ</h3>
                <button @click="showShoppingModal = false" class="text-gray-400 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <!-- Level 1 Filter: Owner Tabs -->
            <div class="flex border-b border-gray-100 mb-2">
                <button @click="shoppingTab='all'" class="flex-1 py-2 text-sm font-bold transition-colors" :class="shoppingTab==='all'?'text-jp-text border-b-2 border-jp-yellow-dark':'text-gray-400'">ÂÖ®ÈÉ®</button>
                <button @click="shoppingTab='yihua'" class="flex-1 py-2 text-sm font-bold transition-colors" :class="shoppingTab==='yihua'?'text-jp-blue border-b-2 border-jp-blue':'text-gray-400'">ÊòìÊ®∫</button>
                <button @click="shoppingTab='sister'" class="flex-1 py-2 text-sm font-bold transition-colors" :class="shoppingTab==='sister'?'text-pink-500 border-b-2 border-pink-500':'text-gray-400'">ÂßäÂßä</button>
            </div>

            <!-- Level 2 Filter: Item Categories (Horizontal Scroll) -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-2 pb-2 mb-2 border-b border-gray-50">
                <button 
                    @click="selectedShoppingCategory='all'"
                    class="whitespace-nowrap px-3 py-1 rounded-full text-xs font-bold transition-colors border"
                    :class="selectedShoppingCategory==='all' ? 'bg-gray-600 text-white border-gray-600' : 'bg-white text-gray-500 border-gray-200'"
                >
                    ÂÖ®ÈÉ®
                </button>
                <button 
                    v-for="cat in shoppingCategories" 
                    :key="cat.id"
                    @click="selectedShoppingCategory=cat.id"
                    class="whitespace-nowrap px-3 py-1 rounded-full text-xs font-bold transition-colors border"
                    :class="selectedShoppingCategory===cat.id ? 'bg-jp-accent text-white border-jp-accent' : 'bg-white text-gray-500 border-gray-200'"
                >
                    {{ cat.name }}
                </button>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto space-y-3 pr-2 hide-scrollbar">
                <div v-if="filteredShoppingList.length === 0" class="text-center py-10 text-gray-300">
                    <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                    <p>ÈÄôÂÄãÂàÜÈ°ûÊòØÁ©∫ÁöÑ</p>
                </div>
                <div v-for="item in filteredShoppingList" :key="item.id" class="bg-white border border-stone-100 rounded-xl p-3 shadow-sm flex gap-3 relative group">
                    <div class="w-20 h-20 bg-gray-50 rounded-lg flex-shrink-0 overflow-hidden border border-gray-100 flex items-center justify-center text-gray-300">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover" onerror="this.style.display='none'">
                        <i v-else class="fa-solid fa-image text-2xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                             <a v-if="item.url" :href="item.url" target="_blank" class="font-bold text-sm text-jp-text truncate hover:text-blue-500 hover:underline block mb-1">{{ item.text }} <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a>
                             <span v-else class="font-bold text-sm text-jp-text truncate block mb-1">{{ item.text }}</span>
                        </div>
                        <div class="flex items-center flex-wrap gap-2 mb-1">
                            <span v-if="item.owner === 'yihua'" class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded font-bold">ÊòìÊ®∫</span>
                            <span v-else-if="item.owner === 'sister'" class="text-[10px] bg-pink-100 text-pink-500 px-1.5 py-0.5 rounded font-bold">ÂßäÂßä</span>
                            
                            <!-- Category Badge -->
                            <span v-if="getShoppingCategoryName(item.category)" class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200">
                                {{ getShoppingCategoryName(item.category) }}
                            </span>
                        </div>
                        <div class="text-sm font-mono text-gray-600">¬•{{ Number(item.price).toLocaleString() }}</div>
                        <div v-if="item.price >= 5500" class="mt-1 flex items-center gap-1">
                            <span class="text-[10px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded font-bold">Tax Free</span>
                            <span class="text-[10px] text-gray-400">ÈÄÄÁ®ÖÂæå ¬•{{ Math.round(item.price / 1.1).toLocaleString() }}</span>
                        </div>
                    </div>
                    <button @click="deleteShoppingItem(item.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 p-1"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </div>

            <!-- Add Form -->
            <div class="mt-4 pt-4 border-t border-gray-100 space-y-2 bg-gray-50 p-3 rounded-xl">
                <!-- Owner Selection -->
                <div class="flex gap-2 mb-2 items-center">
                    <label class="text-xs font-bold text-gray-400 self-center mr-1">ÊòØË™∞Ë¶ÅË≤∑Ôºü</label>
                    <label class="flex items-center gap-1 cursor-pointer bg-white px-2 py-1 rounded border border-gray-200">
                        <input type="radio" v-model="newShoppingItem.owner" value="yihua" class="accent-blue-500">
                        <span class="text-xs font-bold" :class="newShoppingItem.owner==='yihua'?'text-blue-600':'text-gray-400'">ÊòìÊ®∫</span>
                    </label>
                    <label class="flex items-center gap-1 cursor-pointer ml-1 bg-white px-2 py-1 rounded border border-gray-200">
                        <input type="radio" v-model="newShoppingItem.owner" value="sister" class="accent-pink-500">
                        <span class="text-xs font-bold" :class="newShoppingItem.owner==='sister'?'text-pink-500':'text-gray-400'">ÂßäÂßä</span>
                    </label>
                </div>

                <div class="flex gap-2">
                    <input v-model="newShoppingItem.url" placeholder="Ë≤º‰∏äÂïÜÂìÅÁ∂≤ÂùÄ..." class="flex-1 bg-white px-3 py-2 rounded-lg text-sm border-none outline-none ring-1 ring-stone-200 focus:ring-jp-blue">
                    <button @click="autoFetchInfo" class="bg-gradient-to-r from-blue-400 to-blue-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm active:scale-95 whitespace-nowrap flex items-center gap-1" :disabled="isFetching">
                         <div v-if="isFetching" class="loader border-white border-t-transparent w-3 h-3"></div>
                         <span v-else>ü™Ñ ÊäìÂèñ</span>
                    </button>
                </div>
                
                <input v-model="newShoppingItem.text" placeholder="ÂïÜÂìÅÂêçÁ®± (ÂèØËá™ÂãïÂ°´ÂÖ•)" class="w-full bg-white px-3 py-2 rounded-lg text-sm border-none outline-none">
                
                <!-- Category Selection & New Category -->
                <div class="flex gap-2 items-center">
                    <div class="flex-1 relative">
                        <select v-model="newShoppingItem.category" class="w-full bg-white px-3 py-2 rounded-lg text-sm border-none outline-none appearance-none">
                            <option value="" disabled>ÈÅ∏ÊìáÂàÜÈ°û</option>
                            <option v-for="cat in shoppingCategories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-xs text-gray-300 pointer-events-none"></i>
                    </div>
                    
                    <button v-if="!showNewShoppingCatInput" @click="showNewShoppingCatInput=true" class="bg-gray-100 text-gray-500 px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap hover:bg-gray-200"><i class="fa-solid fa-plus"></i></button>
                    
                    <div v-else class="flex gap-1 flex-1">
                        <input v-model="newShoppingCatName" placeholder="Êñ∞ÂàÜÈ°û..." class="w-full bg-white px-2 py-2 rounded-lg text-xs border border-jp-accent outline-none">
                        <button @click="addShoppingCategory" class="bg-jp-accent text-white px-2 rounded-lg text-xs"><i class="fa-solid fa-check"></i></button>
                        <button @click="showNewShoppingCatInput=false" class="bg-gray-200 text-gray-500 px-2 rounded-lg text-xs"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>

                <div class="flex gap-2">
                    <input v-model="newShoppingItem.price" type="number" placeholder="ÂîÆÂÉπ ¬•" class="flex-1 bg-white px-3 py-2 rounded-lg text-sm border-none outline-none">
                    <input v-model="newShoppingItem.image" placeholder="ÂúñÁâáÈÄ£Áµê" class="flex-1 bg-white px-3 py-2 rounded-lg text-sm border-none outline-none">
                </div>
                
                <button @click="addShoppingItem" class="w-full bg-jp-yellow text-jp-text font-bold py-2 rounded-lg text-sm shadow-sm hover:bg-jp-yellow-dark transition-colors">Âä†ÂÖ•Ê∏ÖÂñÆ</button>
            </div>
        </div>
    </div>
    </transition>

    <transition name="modal"><div v-if="showModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4">{{ isEditing?'Á∑®ËºØ':'Êñ∞Â¢û' }}Ë°åÁ®ã</h3><div class="space-y-4"><input type="time" v-model="form.time" class="w-full bg-gray-50 p-3 rounded-xl"><input v-model="form.location" placeholder="Âú∞Èªû" class="w-full bg-gray-50 p-3 rounded-xl"><select v-model="form.type" class="w-full bg-gray-50 p-3 rounded-xl"><option value="spot">ÊôØÈªû</option><option value="food">ÁæéÈ£ü</option><option value="shop">Ë≥ºÁâ©</option><option value="transport">‰∫§ÈÄö</option></select><div v-if="form.type==='spot'" class="flex items-center"><input type="checkbox" v-model="form.nursing" class="mr-2">ÈúÄË¶ÅËÇ≤Â¨∞Ë®≠ÊñΩ</div><textarea v-model="form.note" placeholder="ÂÇôË®ª" class="w-full bg-gray-50 p-3 rounded-xl"></textarea></div><div class="flex gap-3 mt-6"><button @click="closeModal" class="flex-1 py-3 bg-gray-100 rounded-xl">ÂèñÊ∂à</button><button @click="saveItem" class="flex-1 py-3 bg-jp-yellow rounded-xl font-bold">ÂÑ≤Â≠ò</button></div></div></div></transition>

    <transition name="modal"><div v-if="showAddExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-lg font-bold text-jp-text mb-4">Ë®òÂ∏≥</h3><div class="flex bg-gray-100 p-1 rounded-lg mb-4"><button @click="expenseForm.currency='JPY'" :class="expenseForm.currency==='JPY'?'bg-white shadow text-jp-text':'text-gray-400'" class="flex-1 py-2 rounded font-bold transition-all">JPY</button><button @click="expenseForm.currency='TWD'" :class="expenseForm.currency==='TWD'?'bg-white shadow text-blue-600':'text-gray-400'" class="flex-1 py-2 rounded font-bold transition-all">TWD</button></div><input type="date" v-model="expenseForm.date" class="w-full mb-3 bg-gray-50 p-3 rounded-xl"><input v-model="expenseForm.item" placeholder="È†ÖÁõÆ" class="w-full mb-3 bg-gray-50 p-3 rounded-xl"><input type="number" v-model="expenseForm.amount" placeholder="ÈáëÈ°ç" class="w-full mb-3 bg-gray-50 p-3 rounded-xl"><div class="mb-3"><select v-model="expenseForm.category" class="w-full bg-gray-50 p-3 rounded-xl mb-2"><option v-for="cat in allCategories" :key="cat.id" :value="cat.id">{{ cat.name }}</option></select><div v-if="!showNewCatInput" @click="showNewCatInput = true" class="text-xs text-blue-500 cursor-pointer text-right font-bold">+ Êñ∞Â¢ûÂàÜÈ°û</div><div v-else class="flex gap-2 mt-2"><input v-model="newCategoryName" placeholder="Êñ∞ÂàÜÈ°ûÂêçÁ®±" class="flex-1 bg-gray-50 p-2 rounded-lg text-sm"><button @click="addCategory" class="bg-blue-500 text-white px-3 rounded-lg text-xs font-bold">ÂÑ≤Â≠ò</button></div></div><div class="flex gap-3 mt-6"><button @click="showAddExpenseModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl">ÂèñÊ∂à</button><button @click="saveExpense" class="flex-1 py-3 bg-jp-text text-white rounded-xl font-bold">Êñ∞Â¢û</button></div></div></div></transition>
    
    <transition name="modal"><div v-if="showAddInfoModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6"><input v-model="newInfo.title" placeholder="Ê®ôÈ°å" class="w-full mb-3 bg-gray-50 p-3 rounded-xl"><input v-model="newInfo.desc" placeholder="ÊèèËø∞" class="w-full mb-3 bg-gray-50 p-3 rounded-xl"><div class="flex gap-3 mt-4"><button @click="showAddInfoModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl">ÂèñÊ∂à</button><button @click="addInfoItem" class="flex-1 py-3 bg-jp-yellow rounded-xl font-bold">Êñ∞Â¢û</button></div></div></div></transition>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- State ---
            const appTitle = ref('ÂÜ¨Â§©ÁöÑÊù±‰∫¨');
            const tripDays = ref(8); // 12/24 - 12/31 = 8 days
            const currentTab = ref('itinerary');
            const tripDates = ref([]);
            const selectedDate = ref('todo'); 
            const currentWeather = ref(null);

            // --- Data ---
            const itinerary = ref([
                { id: 1, date: '2024-12-24', time: '14:00', location: 'ÊàêÁî∞Ê©üÂ†¥', type: 'transport', note: 'ÊäµÈÅî', order: 0, lat: 35.7719, lng: 140.3929 },
                { id: 2, date: '2024-12-24', time: '16:00', location: 'Êñ∞ÂÆøÈ£ØÂ∫ó', type: 'spot', note: 'Check-in', order: 1, lat: 35.6905, lng: 139.7000 },
                { id: 3, date: '2024-12-25', time: '10:00', location: 'Ëø™Â£´Â∞ºÊ®ÇÂúí', type: 'spot', note: 'ËÅñË™ïÁØÄÊ¥ªÂãï', order: 0, lat: 35.6329, lng: 139.8804 }
            ]);
            const todos = ref([{ id: 1, text: 'È†êË®ÇËÅñË™ïÊôöÈ§ê', done: false }]);
            
            // Updated Shopping List Data with Category
            const shoppingList = ref([
                { id: 1, text: 'Á¶èË¢ã', price: 10000, url: '', image: '', owner: 'yihua', category: 'cat_outer' }
            ]);
            
            const expenses = ref([]);
            const infoItems = ref([]);
            const igSearchText = ref('');
            const isFetching = ref(false);

            // --- Categories State (Expenses) ---
            const defaultCategories = [
                { id: 'food', name: 'È£≤È£ü', icon: 'fa-utensils' },
                { id: 'transport', name: '‰∫§ÈÄö', icon: 'fa-train' },
                { id: 'shopping', name: 'Ë≥ºÁâ©', icon: 'fa-bag-shopping' },
                { id: 'other', name: 'ÂÖ∂‰ªñ', icon: 'fa-file-invoice' }
            ];
            const customCategories = ref([]);
            const showNewCatInput = ref(false);
            const newCategoryName = ref('');

            // --- Categories State (Shopping) ---
            const defaultShoppingCategories = [
                { id: 'cat_outer', name: 'Â§ñÂ•ó' },
                { id: 'cat_pants', name: 'Ë§≤Â≠ê' },
                { id: 'cat_souvenir', name: '‰º¥ÊâãÁ¶Æ' },
                { id: 'cat_gacha', name: 'Êâ≠Ëõã' },
                { id: 'cat_cosmetic', name: 'Ëó•Â¶ù' },
                { id: 'cat_elec', name: 'ÈõªÂô®' },
                { id: 'cat_snack', name: 'Èõ∂È£ü' }
            ];
            const shoppingCategories = ref([...defaultShoppingCategories]);
            const selectedShoppingCategory = ref('all');
            const showNewShoppingCatInput = ref(false);
            const newShoppingCatName = ref('');

            // --- Forms ---
            const exchangeRate = ref(0.215);
            const showModal = ref(false);
            const showAddExpenseModal = ref(false);
            const showShoppingModal = ref(false);
            const showAddInfoModal = ref(false);
            const showTransportModal = ref(false);
            const isEditing = ref(false);
            const form = ref({});
            const expenseForm = ref({ currency: 'JPY', category: 'food' });
            const transportForm = ref({ origin: '', destination: '', mode: 'train', time: 0, cost: 0, itemId: null });
            
            // Updated Shopping Item Form
            const newShoppingItem = ref({ text: '', price: '', url: '', image: '', owner: 'yihua', category: '' });
            const shoppingTab = ref('all'); // all, yihua, sister

            const newInfo = ref({});
            const newTodoText = ref('');

            // --- Map ---
            let map = null;
            let markers = [];
            let sortableInstance = null;

            // --- Init Logic ---
            const initDates = () => {
                const dates = [];
                const start = new Date('2024-12-24');
                for(let i=0; i<8; i++) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    dates.push(d.toISOString().split('T')[0]);
                }
                tripDates.value = dates;
                if(tripDates.value.length > 0 && selectedDate.value !== 'todo') {
                     fetchWeather(selectedDate.value);
                }
            };

            // --- Auto Fetch Logic ---
            const autoFetchInfo = async () => {
                const url = newShoppingItem.value.url;
                if(!url) return alert('Ë´ãÂÖàËº∏ÂÖ•Á∂≤ÂùÄ');
                isFetching.value = true;

                const proxies = [
                    u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                    u => `https://thingproxy.freeboard.io/fetch/${u}`
                ];

                let htmlContent = null;
                for (const makeProxyUrl of proxies) {
                    try {
                        const res = await fetch(makeProxyUrl(url));
                        if(res.ok) { htmlContent = await res.text(); break; }
                    } catch(e) { console.log('Proxy failed, trying next...'); }
                }

                if(htmlContent) {
                    try {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlContent, "text/html");
                        const ogImage = doc.querySelector('meta[property="og:image"]')?.content || doc.querySelector('meta[name="og:image"]')?.content || doc.querySelector('link[rel="image_src"]')?.href || doc.querySelector('.img-tag-wrapper img')?.src;
                        if(ogImage) newShoppingItem.value.image = ogImage;
                        const ogTitle = doc.querySelector('meta[property="og:title"]')?.content || doc.querySelector('meta[name="title"]')?.content || doc.querySelector('h1')?.innerText || doc.title;
                        if(ogTitle) newShoppingItem.value.text = ogTitle.trim();
                        const bodyText = doc.body.innerText;
                        const priceRegex = /(?:¬•|Ôø•|JPY|JP¬•)\s*([0-9,]+)|([0-9,]+)\s*ÂÜÜ/i;
                        const match = bodyText.match(priceRegex);
                        const schemaPrice = doc.querySelector('[itemprop="price"]')?.content || doc.querySelector('[itemprop="price"]')?.innerText;
                        let priceStr = '';
                        if(schemaPrice) priceStr = schemaPrice; else if (match) priceStr = match[1] || match[2];
                        if(priceStr) { priceStr = priceStr.replace(/[,.]/g, ''); if(!isNaN(priceStr)) newShoppingItem.value.price = priceStr; }
                    } catch(e) { console.error(e); alert('Ëß£ÊûêÁ∂≤È†ÅÂÖßÂÆπÊôÇÁôºÁîüÈåØË™§„ÄÇ'); }
                } else { alert('‚ö†Ô∏è Ëá™ÂãïÊäìÂèñÂ§±Êïó\nÂª∫Ë≠∞ÊâãÂãïËº∏ÂÖ•„ÄÇ'); }
                isFetching.value = false;
            };

            // --- Optimization ---
            const optimizeRoute = () => {
                if(currentDayItinerary.value.length < 3) return;
                const items = [...currentDayItinerary.value];
                const startNode = items[0];
                const optimized = [startNode];
                const unvisited = items.slice(1);
                let current = startNode;
                while(unvisited.length > 0) {
                    let nearestIndex = -1, minDist = Infinity;
                    const cLat = current.lat || 35.6895, cLng = current.lng || 139.6917;
                    unvisited.forEach((node, idx) => {
                        const nLat = node.lat || 35.6895, nLng = node.lng || 139.6917;
                        const dist = Math.pow(nLat - cLat, 2) + Math.pow(nLng - cLng, 2);
                        if(dist < minDist) { minDist = dist; nearestIndex = idx; }
                    });
                    if(nearestIndex !== -1) { current = unvisited[nearestIndex]; optimized.push(current); unvisited.splice(nearestIndex, 1); } 
                    else { optimized.push(unvisited.pop()); }
                }
                optimized.forEach((item, index) => { const realItem = itinerary.value.find(i => i.id === item.id); if(realItem) realItem.order = index; });
                alert('Ë∑ØÂæëÂ∑≤‰æùÁÖßË∑ùÈõ¢ÊúÄ‰Ω≥ÂåñÔºÅ'); saveData();
            };

            // --- IG Search ---
            const searchIgLocation = () => {
                if(!igSearchText.value) return;
                const query = igSearchText.value;
                if(confirm(`Ë¶ÅÂú® Google Maps ‰∏äÊêúÂ∞ã‰∏¶Âä†ÂÖ• "${query}" ÂóéÔºü`)) {
                    window.open(`https://www.google.com/maps/search/${encodeURIComponent(query + ' Êù±‰∫¨')}`, '_blank');
                    itinerary.value.push({id: Date.now(), date: selectedDate.value === 'todo' ? tripDates.value[0] : selectedDate.value, time: '12:00', location: query, type: 'spot', note: '‰æÜËá™ IG', order: currentDayItinerary.value.length, lat: 35.6580, lng: 139.7016});
                    saveData(); igSearchText.value = '';
                }
            };

            // --- Categories (Expenses) ---
            const allCategories = computed(() => [...defaultCategories, ...customCategories.value]);
            const addCategory = () => { if(newCategoryName.value) { customCategories.value.push({id: 'cat_'+Date.now(), name: newCategoryName.value, icon: 'fa-tag'}); newCategoryName.value=''; showNewCatInput.value=false; saveData(); } };

            // --- Categories (Shopping) Logic ---
            const addShoppingCategory = () => {
                if(newShoppingCatName.value) {
                    const newId = 'cat_s_' + Date.now();
                    shoppingCategories.value.push({ id: newId, name: newShoppingCatName.value });
                    newShoppingItem.value.category = newId; // Auto select new category
                    newShoppingCatName.value = '';
                    showNewShoppingCatInput.value = false;
                    saveData();
                }
            };
            const getShoppingCategoryName = (id) => {
                const cat = shoppingCategories.value.find(c => c.id === id);
                return cat ? cat.name : '';
            };

            // --- Weather ---
            const fetchWeather = async (dateStr) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    const idx = data.daily.time.indexOf(dateStr) !== -1 ? data.daily.time.indexOf(dateStr) : 0;
                    currentWeather.value = { weathercode: data.daily.weathercode[idx], temp_max: Math.round(data.daily.temperature_2m_max[idx]), temp_min: Math.round(data.daily.temperature_2m_min[idx]) };
                } catch(e) { currentWeather.value = null; }
            };
            const getWeatherIcon = (c) => (c===0?'fa-solid fa-sun text-orange-400':(c>=1&&c<=3?'fa-solid fa-cloud-sun text-yellow-500':'fa-solid fa-cloud text-gray-400'));
            const getClothingAdvice = (max, min) => 'ÂÜ¨Êó•‰øùÊöñÔºöÂª∫Ë≠∞ÁæΩÁµ®Êúç„ÄÅÂúçÂ∑æ„ÄÅÊâãÂ•ó';

            // --- Computed ---
            const currentDayItinerary = computed(() => selectedDate.value === 'todo' ? [] : itinerary.value.filter(item => item.date === selectedDate.value).sort((a, b) => a.order - b.order));
            const groupedExpenses = computed(() => { const g={}; [...expenses.value].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>{if(!g[e.date])g[e.date]=[];g[e.date].push(e)}); return g; });
            const grandTotalTWD = computed(() => (expenses.value.reduce((s,i)=>s+(Number(i.amount)*(i.currency==='JPY'?exchangeRate.value:1)),0) + itinerary.value.reduce((s,i)=>s+((i.transport?.cost||0)*exchangeRate.value),0)).toFixed(0));
            
            // Shopping Filter (Owner + Category)
            const filteredShoppingList = computed(() => {
                let list = shoppingList.value;
                // Filter by Owner
                if(shoppingTab.value !== 'all') {
                    list = list.filter(item => item.owner === shoppingTab.value);
                }
                // Filter by Category
                if(selectedShoppingCategory.value !== 'all') {
                    list = list.filter(item => item.category === selectedShoppingCategory.value);
                }
                return list;
            });

            // --- Methods ---
            const getDayRange = () => '2024/12/24 - 12/31';
            const getDayIndex = (d) => tripDates.value.indexOf(d) + 1;
            const getWeekDay = (d) => ['ÈÄ±Êó•','ÈÄ±‰∏Ä','ÈÄ±‰∫å','ÈÄ±‰∏â','ÈÄ±Âõõ','ÈÄ±‰∫î','ÈÄ±ÂÖ≠'][new Date(d).getDay()];
            
            const openAddItemModal = () => { isEditing.value=false; form.value={id:Date.now(),time:'10:00',location:'',type:'spot',note:'',nursing:false, lat: 35.6895+(Math.random()-0.5)*0.05, lng: 139.6917+(Math.random()-0.5)*0.05}; showModal.value=true; };
            const editItem=(item)=>{ isEditing.value=true; form.value={...item}; showModal.value=true; };
            const saveItem=()=>{ const newItem={...form.value, date:selectedDate.value, order: isEditing.value ? form.value.order : currentDayItinerary.value.length}; if(!newItem.lat){newItem.lat=35.6895;newItem.lng=139.6917;} if(isEditing.value){const idx=itinerary.value.findIndex(i=>i.id===newItem.id);itinerary.value[idx]=newItem;}else{itinerary.value.push(newItem);} saveData(); showModal.value=false; };
            const deleteItem=(id)=>{ if(confirm('Âà™Èô§?')) itinerary.value=itinerary.value.filter(i=>i.id!==id); saveData(); };
            const addTodo=()=>{ if(newTodoText.value) todos.value.push({id:Date.now(),text:newTodoText.value}); newTodoText.value=''; saveData(); };
            const deleteTodo=(id)=>todos.value=todos.value.filter(t=>t.id!==id);
            const saveExpense=()=>{ if(expenseForm.value.amount) expenses.value.push({...expenseForm.value, id:Date.now()}); showAddExpenseModal.value=false; saveData(); };
            const deleteExpense=(id)=>expenses.value=expenses.value.filter(e=>e.id!==id);
            const addInfoItem=()=>{ if(newInfo.value.title) infoItems.value.push({...newInfo.value, id:Date.now()}); showAddInfoModal.value=false; saveData(); };
            const deleteInfoItem=(id)=>infoItems.value=infoItems.value.filter(i=>i.id!==id);
            const editTitle=()=>{ const t=prompt('ÊóÖÁ®ãÂêçÁ®±',appTitle.value); if(t) appTitle.value=t; saveData(); };
            const addDay=()=>{}; 

            const getTypeColor=(t)=>({spot:'bg-jp-accent',food:'bg-orange-400',shop:'bg-pink-400',transport:'bg-blue-400'}[t]||'bg-gray-400');
            const getTypeIcon=(t)=>({spot:'fa-camera',food:'fa-utensils',shop:'fa-bag-shopping',transport:'fa-train'}[t]||'fa-map-pin');
            const getTypeName=(t)=>({spot:'ÊôØÈªû',food:'ÁæéÈ£ü',shop:'Ë≥ºÁâ©',transport:'ÁßªÂãï'}[t]||'ÂÖ∂‰ªñ');
            const getCategoryIcon=(c)=>{ const cat=allCategories.value.find(ct=>ct.id===c); return cat?`fa-solid ${cat.icon}`:'fa-solid fa-circle'; };
            const getCategoryName=(c)=>{ const cat=allCategories.value.find(ct=>ct.id===c); return cat?cat.name:'ÂÖ∂‰ªñ'; };
            const getDailyTotal=(g)=>g.reduce((s,i)=>{let a=Number(i.amount); return s+(i.currency==='JPY'?a*exchangeRate.value:a)},0).toFixed(0);
            const getGoogleMapsLink=(l)=>`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l+' Êù±‰∫¨')}`;
            const getGoogleMapsRouteLink=()=>{ if(currentDayItinerary.value.length===0)return'#'; const locs=currentDayItinerary.value.map(i=>i.location+' Êù±‰∫¨'); const origin=locs[0]; const dest=locs[locs.length-1]; const wps=locs.slice(1,-1).join('|'); return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&waypoints=${encodeURIComponent(wps)}&travelmode=transit`; };

            const openTransportModal = (c,n) => { if(!n)return; transportForm.value={origin:c.location,destination:n.location,mode:c.transport?.mode||'train',time:c.transport?.time||0,cost:c.transport?.cost||0,itemId:c.id}; showTransportModal.value=true; };
            const saveTransport = () => { const idx=itinerary.value.findIndex(i=>i.id===transportForm.value.itemId); if(idx!==-1)itinerary.value[idx].transport={mode:transportForm.value.mode,time:transportForm.value.time,cost:transportForm.value.cost}; saveData(); showTransportModal.value=false; };
            const getTransportIcon = (m) => ({train:'fa-solid fa-train',walk:'fa-solid fa-person-walking',taxi:'fa-solid fa-taxi',bus:'fa-solid fa-bus'}[m]||'fa-solid fa-arrow-right');

            // Shopping Logic
            const addShoppingItem = () => { 
                if(!newShoppingItem.value.text)return; 
                const item = { id:Date.now(), ...newShoppingItem.value };
                shoppingList.value.push(item); 
                newShoppingItem.value={ text:'', price:'', url:'', image:'', owner: newShoppingItem.value.owner, category: newShoppingItem.value.category }; // Preserve selects
                saveData(); 
            };
            const deleteShoppingItem = (id) => { shoppingList.value=shoppingList.value.filter(i=>i.id!==id); saveData(); };

            // Persistence
            const saveData = () => localStorage.setItem('tokyo_trip_v12', JSON.stringify({ 
                title: appTitle.value, itinerary: itinerary.value, todos: todos.value, shopping: shoppingList.value, expenses: expenses.value, info: infoItems.value, customCategories: customCategories.value, 
                shoppingCategories: shoppingCategories.value // Save shopping cats
            }));
            const loadData = () => { 
                const d=JSON.parse(localStorage.getItem('tokyo_trip_v12')); 
                if(d){
                    appTitle.value=d.title; itinerary.value=d.itinerary; todos.value=d.todos; shoppingList.value=d.shopping; expenses.value=d.expenses; infoItems.value=d.info; 
                    if(d.customCategories) customCategories.value=d.customCategories;
                    if(d.shoppingCategories) shoppingCategories.value=d.shoppingCategories; // Load shopping cats
                } 
                initDates(); 
            };

            // Map & Sortable
            const switchTab=(t)=>{ currentTab.value=t; if(t==='map') nextTick(()=>{ initMap(); updateMap(); }); };
            const initMap=()=>{ if(map)return; map=L.map('map-container',{zoomControl:false}).setView([35.6895,139.6917],12); L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'] }).addTo(map); };
            const updateMap=()=>{ if(!map)return; markers.forEach(m=>map.removeLayer(m)); markers=[]; const pts=currentDayItinerary.value; if(pts.length===0)return; const b=L.latLngBounds(); pts.forEach((p,i)=>{ const lat=p.lat||(35.6895+(Math.random()-0.5)*0.05); const lng=p.lng||(139.6917+(Math.random()-0.5)*0.05); const m=L.marker([lat,lng]).addTo(map).bindPopup(`${i+1}. ${p.location}`); markers.push(m); b.extend([lat,lng]); }); map.fitBounds(b,{padding:[50,50]}); };
            const locateUser=()=>{ navigator.geolocation.getCurrentPosition(p=>{ L.marker([p.coords.latitude,p.coords.longitude]).addTo(map).bindPopup('You').openPopup(); map.setView([p.coords.latitude,p.coords.longitude],15); }) };
            
            watch(selectedDate, async (n)=>{ if(n!=='todo'&&currentTab.value==='itinerary'){ await nextTick(); const el=document.querySelector('.relative.group')?.parentElement; if(el){ if(sortableInstance)sortableInstance.destroy(); sortableInstance=Sortable.create(el,{ handle:'.handle', animation:150, ghostClass:'sortable-ghost', onEnd:(evt)=>{ const items=itinerary.value.filter(i=>i.date===selectedDate.value).sort((a,b)=>a.order-b.order); const moved=items.splice(evt.oldIndex,1)[0]; items.splice(evt.newIndex,0,moved); items.forEach((it,ix)=>{ const r=itinerary.value.find(i=>i.id===it.id); if(r)r.order=ix; }); saveData(); } }); } fetchWeather(n); } });

            onMounted(()=>{ loadData(); });

            return {
                appTitle, tripDays, tripDates, selectedDate, currentTab, currentWeather, itinerary, currentDayItinerary, todos, shoppingList, expenses, infoItems, exchangeRate, grandTotalTWD, groupedExpenses, showModal, showAddExpenseModal, showShoppingModal, showAddInfoModal, showTransportModal, isEditing, form, expenseForm, transportForm, newShoppingItem, newInfo, newTodoText,
                getTypeColor, getTypeIcon, getTypeName, getCategoryIcon, getCategoryName, getDailyTotal, getTransportIcon, getWeatherIcon, getClothingAdvice, getGoogleMapsLink, getGoogleMapsRouteLink, getDayRange, getDayIndex, getWeekDay,
                openAddItemModal, editItem, saveItem, deleteItem, addTodo, deleteTodo, saveExpense, deleteExpense, addInfoItem, deleteInfoItem, addShoppingItem, deleteShoppingItem, openTransportModal, saveTransport, switchTab, locateUser, editTitle, addDay, fetchWeather,
                igSearchText, searchIgLocation, optimizeRoute, allCategories, customCategories, showNewCatInput, newCategoryName, addCategory, autoFetchInfo, isFetching,
                // New
                shoppingTab, filteredShoppingList, shoppingCategories, selectedShoppingCategory, addShoppingCategory, showNewShoppingCatInput, newShoppingCatName, getShoppingCategoryName
            };
        }
    }).mount('#app');
</script>
</body>
</html>